/* BackgroundCheck
   http://kennethcachia.com/background-check
   v1.2.2 */

!function(t,e){"function"==typeof define&&define.amd?define(e):t.BackgroundCheck=e(t)}(this,function(){"use strict";function t(t){if(void 0===t||void 0===t.targets)throw"Missing attributes";D.debug=n(t.debug,!1),D.debugOverlay=n(t.debugOverlay,!1),D.targets=r(t.targets),D.images=r(t.images||"img",!0),D.changeParent=n(t.changeParent,!1),D.threshold=n(t.threshold,50),D.minComplexity=n(t.minComplexity,30),D.minOverlap=n(t.minOverlap,50),D.windowEvents=n(t.windowEvents,!0),D.maxDuration=n(t.maxDuration,500),D.mask=n(t.mask,{r:0,g:255,b:0}),D.classes=n(t.classes,{dark:"background--dark",light:"background--light",complex:"background--complex"}),void 0===L&&(g(),L&&(S.style.position="fixed",S.style.top="0px",S.style.left="0px",S.style.width="100%",S.style.height="100%",M=x.bind(null,function(){h(),C()}),window.addEventListener(B,M),E=x.bind(null,C),window.addEventListener("scroll",E),h(),C()))}function e(){p(),L&&(window.removeEventListener(B,M),window.removeEventListener("scroll",E),M=void 0,E=void 0),L=void 0,S=void 0,I=void 0,D={},N&&clearTimeout(N)}function i(t){H("debug")&&console.log(t)}function n(t,e){return o(t,typeof e),void 0===t?e:t}function o(t,e){if(void 0!==t&&typeof t!==e)throw"Incorrect attribute type"}function a(t){for(var e,n,o=[],a=0;a<t.length;a++)if(e=t[a],o.push(e),"IMG"!==e.tagName){if(n=window.getComputedStyle(e).backgroundImage,n.split(/,url|, url/).length>1)throw"Multiple backgrounds are not supported";if(!n||"none"===n)throw"Element is not an <img> but does not have a background-image";o[a]={img:new Image,el:o[a]},n=n.slice(4,-1),n=n.replace(/"/g,""),o[a].img.src=n,i("CSS Image - "+n)}return o}function r(t,e){var i=t;if("string"==typeof t?i=document.querySelectorAll(t):t&&1===t.nodeType&&(i=[t]),!i||0===i.length||void 0===i.length)throw"Elements not found";return e&&(i=a(i)),i=Array.prototype.slice.call(i)}function g(){S=document.createElement("canvas"),S&&S.getContext?(I=S.getContext("2d"),L=!0):L=!1,l()}function l(){H("debugOverlay")?(S.style.opacity=.5,S.style.pointerEvents="none",document.body.appendChild(S)):S.parentNode&&S.parentNode.removeChild(S)}function d(t){var n=(new Date).getTime()-t;i("Duration: "+n+"ms"),n>H("maxDuration")&&(console.log("BackgroundCheck - Killed"),p(),e())}function h(){R={left:0,top:0,right:document.body.clientWidth,bottom:window.innerHeight},S.width=document.body.clientWidth,S.height=window.innerHeight}function u(t,e,i){var n,o;return-1!==t.indexOf("px")?n=parseFloat(t):-1!==t.indexOf("%")?(n=parseFloat(t),o=n/100,n=o*e,i&&(n-=i*o)):n=e,n}function m(t){var e=window.getComputedStyle(t.el);t.el.style.backgroundRepeat="no-repeat",t.el.style.backgroundOrigin="padding-box";var i=e.backgroundSize.split(" "),n=i[0],o=void 0===i[1]?"auto":i[1],a=t.el.clientWidth/t.el.clientHeight,r=t.img.naturalWidth/t.img.naturalHeight;"cover"===n?a>=r?(n="100%",o="auto"):(n="auto",i[0]="auto",o="100%"):"contain"===n&&(1/r>1/a?(n="auto",i[0]="auto",o="100%"):(n="100%",o="auto")),n="auto"===n?t.img.naturalWidth:u(n,t.el.clientWidth),o="auto"===o?n/t.img.naturalWidth*t.img.naturalHeight:u(o,t.el.clientHeight),"auto"===i[0]&&"auto"!==i[1]&&(n=o/t.img.naturalHeight*t.img.naturalWidth);var g=e.backgroundPosition;"top"===g?g="50% 0%":"left"===g?g="0% 50%":"right"===g?g="100% 50%":"bottom"===g?g="50% 100%":"center"===g&&(g="50% 50%"),g=g.split(" ");var l,d;return 4===g.length?(l=g[1],d=g[3]):(l=g[0],d=g[1]),d=d||"50%",l=u(l,t.el.clientWidth,n),d=u(d,t.el.clientHeight,o),4===g.length&&("right"===g[0]&&(l=t.el.clientWidth-t.img.naturalWidth-l),"bottom"===g[2]&&(d=t.el.clientHeight-t.img.naturalHeight-d)),l+=t.el.getBoundingClientRect().left,d+=t.el.getBoundingClientRect().top,{left:Math.floor(l),right:Math.floor(l+n),top:Math.floor(d),bottom:Math.floor(d+o),width:Math.floor(n),height:Math.floor(o)}}function s(t){var e,i,n;if(t.nodeType){var o=t.getBoundingClientRect();e={left:o.left,right:o.right,top:o.top,bottom:o.bottom,width:o.width,height:o.height},n=t.parentNode,i=t}else e=m(t),n=t.el,i=t.img;n=n.getBoundingClientRect(),e.imageTop=0,e.imageLeft=0,e.imageWidth=i.naturalWidth,e.imageHeight=i.naturalHeight;var a,r=e.imageHeight/e.height;return e.top<n.top&&(a=n.top-e.top,e.imageTop=r*a,e.imageHeight-=r*a,e.top+=a,e.height-=a),e.left<n.left&&(a=n.left-e.left,e.imageLeft+=r*a,e.imageWidth-=r*a,e.width-=a,e.left+=a),e.bottom>n.bottom&&(a=e.bottom-n.bottom,e.imageHeight-=r*a,e.height-=a),e.right>n.right&&(a=e.right-n.right,e.imageWidth-=r*a,e.width-=a),e.imageTop=Math.floor(e.imageTop),e.imageLeft=Math.floor(e.imageLeft),e.imageHeight=Math.floor(e.imageHeight),e.imageWidth=Math.floor(e.imageWidth),e}function c(t){var e=s(t);t=t.nodeType?t:t.img,e.imageWidth>0&&e.imageHeight>0&&e.width>0&&e.height>0?I.drawImage(t,e.imageLeft,e.imageTop,e.imageWidth,e.imageHeight,e.left,e.top,e.width,e.height):i("Skipping image - "+t.src+" - area too small")}function f(t,e,i){var n=t.className;switch(i){case"add":n+=" "+e;break;case"remove":var o=new RegExp("(?:^|\\s)"+e+"(?!\\S)","g");n=n.replace(o,"")}t.className=n.trim()}function p(t){for(var e,i=t?[t]:H("targets"),n=0;n<i.length;n++)e=i[n],e=H("changeParent")?e.parentNode:e,f(e,H("classes").light,"remove"),f(e,H("classes").dark,"remove"),f(e,H("classes").complex,"remove")}function v(t){var e,n,o,a,r=t.getBoundingClientRect(),g=0,l=0,d=0,h=0,u=H("mask");if(r.width>0&&r.height>0){p(t),t=H("changeParent")?t.parentNode:t,n=I.getImageData(r.left,r.top,r.width,r.height).data;for(var m=0;m<n.length;m+=4)n[m]===u.r&&n[m+1]===u.g&&n[m+2]===u.b?h++:(g++,e=.2126*n[m]+.7152*n[m+1]+.0722*n[m+2],o=e-d,l+=o*o,d+=o/g);h<=n.length/4*(1-H("minOverlap")/100)&&(a=Math.sqrt(l/g)/255,d/=255,i("Target: "+t.className+" lum: "+d+" var: "+a),f(t,d<=H("threshold")/100?H("classes").dark:H("classes").light,"add"),a>H("minComplexity")/100&&f(t,H("classes").complex,"add"))}}function w(t,e){return t=(t.nodeType?t:t.el).getBoundingClientRect(),e=e===R?e:(e.nodeType?e:e.el).getBoundingClientRect(),!(t.right<e.left||t.left>e.right||t.top>e.bottom||t.bottom<e.top)}function y(t){for(var e,i=(new Date).getTime(),n=t&&("IMG"===t.tagName||t.img)?"image":"targets",o=t?!1:!0,a=H("targets").length,r=0;a>r;r++)e=H("targets")[r],w(e,R)&&("targets"!==n||t&&t!==e?"image"===n&&w(e,t)&&v(e):(o=!0,v(e)));if("targets"===n&&!o)throw t+" is not a target";d(i)}function b(t){var e=function(t){var e=0;return"static"!==window.getComputedStyle(t).position&&(e=parseInt(window.getComputedStyle(t).zIndex,10)||0,e>=0&&e++),e},i=t.parentNode,n=i?e(i):0,o=e(t);return 1e5*n+o}function k(t){var e=!1;return t.sort(function(t,i){t=t.nodeType?t:t.el,i=i.nodeType?i:i.el;var n=t.compareDocumentPosition(i),o=0;return t=b(t),i=b(i),t>i&&(e=!0),t===i&&2===n?o=1:t===i&&4===n&&(o=-1),o||t-i}),i("Sorted: "+e),e&&i(t),e}function C(t,e,n){if(L){var o=H("mask");i("--- BackgroundCheck ---"),i("onLoad event: "+(n&&n.src)),e!==!0&&(I.clearRect(0,0,S.width,S.height),I.fillStyle="rgb("+o.r+", "+o.g+", "+o.b+")",I.fillRect(0,0,S.width,S.height));for(var a,r,g=n?[n]:H("images"),l=k(g),d=!1,h=0;h<g.length;h++)a=g[h],w(a,R)&&(r=a.nodeType?a:a.img,0===r.naturalWidth?(d=!0,i("Loading... "+a.src),r.removeEventListener("load",C),l?r.addEventListener("load",C.bind(null,null,!1,null)):r.addEventListener("load",C.bind(null,t,!0,a))):(i("Drawing: "+a.src),c(a)));n||d?n&&y(n):y(t)}}function x(t){H("windowEvents")===!0&&(N&&clearTimeout(N),N=setTimeout(t,200))}function W(t,e){if(void 0===D[t])throw"Unknown property - "+t;if(void 0===e)throw"Missing value for "+t;if("targets"===t||"images"===t)try{e=r("images"!==t||e?e:"img","images"===t?!0:!1)}catch(i){throw e=[],i}else o(e,typeof D[t]);p(),D[t]=e,C(),"debugOverlay"===t&&l()}function H(t){if(void 0===D[t])throw"Unknown property - "+t;return D[t]}function T(){for(var t,e=H("images"),i=[],n=0;n<e.length;n++)t=s(e[n]),i.push(t);return i}var M,E,L,S,I,N,R,B=void 0!==window.orientation?"orientationchange":"resize",D={};return{init:t,destroy:e,refresh:C,set:W,get:H,getImageData:T}});
